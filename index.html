<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Object & Hand Detection</title>

<!-- TensorFlow.js & COCO-SSD -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>

<style>
  body { margin:0; background:#111; color:#fff; font-family:Arial, sans-serif; text-align:center; }
  video, canvas { width:100%; max-width:600px; border:1px solid #333; }
  #info { padding:10px; font-size:18px; white-space:pre-line; text-align:left; }
  #startBtn { margin:10px; padding:10px 18px; font-size:16px; border-radius:8px; background:#333; color:#fff; border:none; }
</style>
</head>
<body>

<h1>Object & Hand Detection</h1>
<p>버튼을 눌러 카메라 시작 후 손/컵/책/병 인식</p>
<button id="startBtn">카메라 시작</button>
<br>
<video id="camera" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>
<div id="info">시작 버튼을 눌러주세요</div>

<!-- 기준 손 이미지 -->
<img id="handImg" src="IMG_0555.jpeg" style="display:none;" />

<script>
const startBtn = document.getElementById('startBtn');
const video = document.getElementById('camera');
const canvas = document.getElementById('canvas');
const info = document.getElementById('info');
const handImg = document.getElementById('handImg');

let model, running = false;
let handMat = null;

startBtn.addEventListener('click', async () => {
  startBtn.style.display = 'none';
  info.innerText = '카메라 권한 요청 중...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    info.innerText = '모델 로드 중...';

    // COCO-SSD 모델 로드
    model = await cocoSsd.load();
    info.innerText = '손 기준 이미지 준비 중...';

    // OpenCV mat로 변환
    handMat = cv.imread(handImg);

    running = true;
    detectLoop();
  } catch(e) {
    console.error(e);
    info.innerText = '카메라 권한 필요 또는 에러 발생';
  }
});

async function detectLoop(){
  if(!running) return;

  // COCO-SSD 객체 감지
  const predictions = await model.detect(video);
  let outText = '';

  const seen = new Set();
  predictions.sort((a,b)=>b.score-a.score);
  for(const p of predictions){
    const label = p.class;
    if((label==='cup' || label==='book' || label==='bottle') && !seen.has(label)){
      outText += `[${label}]\n감지됨\n\n`;
      seen.add(label);
    }
  }

  // OpenCV를 사용한 손 이미지 비교
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video,0,0);
  const frameMat = cv.imread(canvas);
  const result = new cv.Mat();
  cv.matchTemplate(frameMat, handMat, result, cv.TM_CCOEFF_NORMED);
  const minMax = cv.minMaxLoc(result);
  if(minMax.maxVal > 0.6){ // 유사도 임계값
    outText += '[손]\n감지됨\n';
  }
  frameMat.delete(); result.delete();

  info.innerText = outText || '등록된 물체가 없습니다.';
  requestAnimationFrame(detectLoop);
}
</script>

</body>
</html>
